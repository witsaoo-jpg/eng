<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="‡∏ù‡∏∂‡∏Å‡∏û‡∏π‡∏î‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏Å‡∏±‡∏ö AI - ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤">
    <meta name="theme-color" content="#9333ea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="English Practice">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üéØ</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üéØ</text></svg>">
    <title>üéØ ‡∏ù‡∏∂‡∏Å‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-bounce-dot {
            animation: bounce 1s infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-blue-50 to-indigo-100 min-h-screen">
    
    <!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå -->
    <div id="scenarioSelection" class="p-4">
        <div class="max-w-4xl mx-auto py-8">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-blue-600 mb-4">
                    üéØ ‡∏ù‡∏∂‡∏Å‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
                </h1>
                <p class="text-xl text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏ù‡∏∂‡∏Å</p>
                <div class="mt-4 inline-flex items-center gap-2 bg-green-100 text-green-800 px-4 py-2 rounded-full">
                    <span class="text-2xl">ü§ñ</span>
                    <span class="font-medium">AI ‡∏à‡∏∞‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á!</span>
                </div>
            </div>

            <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏° -->
            <div class="grid md:grid-cols-4 gap-4 mb-8" id="statsOverview"></div>

            <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå -->
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8" id="scenarioGrid"></div>

            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ -->
            <div class="text-center mb-8">
                <button onclick="showHistory()" class="bg-white px-6 py-3 rounded-xl shadow-lg hover:shadow-xl transition-all font-medium text-gray-800 inline-flex items-center gap-2">
                    üìö ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
                </button>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-lg">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                    üìñ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                </h3>
                <ul class="space-y-2 text-gray-600">
                    <li>‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å</li>
                    <li>üé§ ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏°‡∏Ñ‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</li>
                    <li>ü§ñ AI ‡∏à‡∏∞‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡πâ‡∏ü‡∏±‡∏á</li>
                    <li>üéØ AI ‡∏à‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</li>
                    <li>üí¨ ‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ô‡∏à‡∏£‡∏¥‡∏á</li>
                    <li>üèÜ ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤</li>
                </ul>
            </div>

            <!-- ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï -->
            <div class="mt-8 text-center">
                <div class="inline-flex items-center gap-2 bg-white px-6 py-3 rounded-full shadow-md">
                    <span class="text-sm text-gray-600">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢</span>
                    <span class="font-bold text-purple-600">‡∏û‡∏ß.‡∏ß‡∏¥‡∏©‡∏ì‡∏∏‡∏Å‡∏£‡∏ì‡πå ‡πÇ‡∏≠‡∏¢‡∏≤</span>
                    <span class="text-sm text-gray-600">& Claude AI</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏ô‡∏ó‡∏ô‡∏≤ -->
    <div id="conversationView" class="hidden flex flex-col h-screen">
        <!-- Header -->
        <div class="bg-white shadow-md p-4">
            <div class="max-w-4xl mx-auto">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl" id="scenarioIcon"></span>
                        <div>
                            <h2 class="font-bold text-gray-800" id="scenarioTitle"></h2>
                            <p class="text-sm text-gray-500">‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏Å‡∏±‡∏ö AI + ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="showStats()" class="px-4 py-2 bg-blue-100 hover:bg-blue-200 rounded-lg transition text-sm font-medium">
                            üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
                        </button>
                        <button onclick="resetConversation()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition text-sm font-medium">
                            üîÑ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
                        </button>
                    </div>
                </div>
                <!-- ‡πÅ‡∏ñ‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -->
                <div class="flex items-center gap-4 text-sm">
                    <div class="flex items-center gap-2">
                        <span>üèÜ</span>
                        <span class="font-bold text-purple-600" id="currentScore">0</span>
                        <span class="text-gray-500">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span>üí¨</span>
                        <span class="font-bold text-blue-600" id="messageCount">0</span>
                        <span class="text-gray-500">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span>üé§</span>
                        <span class="font-bold text-green-600" id="speakCount">0</span>
                        <span class="text-gray-500">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏π‡∏î</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div class="flex-1 overflow-y-auto p-4" id="messagesContainer">
            <div class="max-w-4xl mx-auto space-y-4" id="messagesList"></div>
        </div>

        <!-- Input -->
        <div class="bg-white border-t p-4">
            <div class="max-w-4xl mx-auto">
                <div id="aiSpeakingIndicator" class="mb-3 text-center hidden">
                    <span class="inline-flex items-center gap-2 bg-blue-100 text-blue-800 px-4 py-2 rounded-full text-sm">
                        <span>üîä</span>
                        AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏π‡∏î...
                    </span>
                </div>
                
                <div class="flex gap-2">
                    <input type="text" id="messageInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°... ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡πÑ‡∏°‡∏Ñ‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î" 
                        class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-purple-400">
                    <button onclick="sendMessage()" id="sendBtn" class="px-6 py-3 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition">
                        ‚úâÔ∏è
                    </button>
                    <button onclick="startListening()" id="micBtn" class="px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-xl hover:from-purple-700 hover:to-blue-700 transition">
                        üé§
                    </button>
                </div>

                <p class="text-center text-xs text-gray-500 mt-2" id="statusText">
                    ‡∏Å‡∏î‡πÑ‡∏°‡∏Ñ‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                </p>
            </div>
        </div>
    </div>

    <!-- Modal ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ -->
    <div id="statsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤</h2>
                <button onclick="closeStats()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="statsContent"></div>
        </div>
    </div>

    <!-- Modal ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ -->
    <div id="historyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">üìö ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</h2>
                <button onclick="closeHistory()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="historyContent"></div>
        </div>
    </div>

    <script>
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå
        const scenarios = [
            {
                id: 1,
                title: "üçï ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô",
                icon: "üçï",
                systemPrompt: "You are a friendly waiter at a restaurant. Have a natural conversation with the customer. Keep responses SHORT (1-2 sentences max). Help them order food, ask about preferences, and be helpful. Speak naturally and casually.",
                greeting: "Hi! Welcome to our restaurant. What can I get for you today?"
            },
            {
                id: 2,
                title: "‚úàÔ∏è ‡∏ó‡∏µ‡πà‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô",
                icon: "‚úàÔ∏è",
                systemPrompt: "You are a helpful airport staff member. Have a natural conversation assisting with check-in, baggage, flight information. Keep responses SHORT (1-2 sentences max). Be professional but friendly.",
                greeting: "Hello! Welcome to the airport. How can I help you today?"
            },
            {
                id: 3,
                title: "üõí ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô",
                icon: "üõí",
                systemPrompt: "You are a friendly shop assistant. Help the customer find items, discuss prices, and make recommendations. Keep responses SHORT (1-2 sentences max). Be helpful and enthusiastic.",
                greeting: "Hi there! Welcome to our store. What are you looking for?"
            },
            {
                id: 4,
                title: "‚òï ‡∏™‡∏±‡πà‡∏á‡∏Å‡∏≤‡πÅ‡∏ü",
                icon: "‚òï",
                systemPrompt: "You are a cheerful barista at a coffee shop. Take orders, suggest drinks, chat about coffee. Keep responses SHORT (1-2 sentences max). Be warm and friendly.",
                greeting: "Hey! What can I make for you today?"
            },
            {
                id: 5,
                title: "üè® ‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏° Check-in",
                icon: "üè®",
                systemPrompt: "You are a polite hotel receptionist. Help with check-in, room requests, and hotel information. Keep responses SHORT (1-2 sentences max). Be professional and courteous.",
                greeting: "Good day! Welcome to our hotel. Checking in?"
            },
            {
                id: 6,
                title: "üí¨ ‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ",
                icon: "üí¨",
                systemPrompt: "You are a friendly English conversation partner. Chat naturally about daily life, hobbies, interests. Keep responses SHORT (1-2 sentences max). Ask follow-up questions to keep conversation going.",
                greeting: "Hey! How's it going? What would you like to talk about?"
            }
        ];

        let currentScenario = null;
        let messages = [];
        let recognition = null;
        let isListening = false;
        let isAISpeaking = false;
        
        // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
        let stats = {
            totalScore: 0,
            totalMessages: 0,
            totalSpeaks: 0,
            vocabulary: new Set(),
            pronunciationIssues: {},
            sessionScore: 0,
            sessionMessages: 0,
            sessionSpeaks: 0
        };

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        function loadData() {
            const saved = localStorage.getItem('englishPracticeStats');
            if (saved) {
                const parsed = JSON.parse(saved);
                stats = {
                    ...parsed,
                    vocabulary: new Set(parsed.vocabulary || []),
                    sessionScore: 0,
                    sessionMessages: 0,
                    sessionSpeaks: 0
                };
            }
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        function saveData() {
            const toSave = {
                ...stats,
                vocabulary: Array.from(stats.vocabulary)
            };
            localStorage.setItem('englishPracticeStats', JSON.stringify(toSave));
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        function addScore(points) {
            stats.totalScore += points;
            stats.sessionScore += points;
            updateScoreDisplay();
            saveData();
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        function updateScoreDisplay() {
            document.getElementById('currentScore').textContent = stats.sessionScore;
            document.getElementById('messageCount').textContent = stats.sessionMessages;
            document.getElementById('speakCount').textContent = stats.sessionSpeaks;
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°
        function renderStatsOverview() {
            const container = document.getElementById('statsOverview');
            container.innerHTML = `
                <div class="bg-white rounded-xl p-4 shadow-md">
                    <div class="text-2xl mb-2">üèÜ</div>
                    <div class="text-2xl font-bold text-purple-600">${stats.totalScore}</div>
                    <div class="text-sm text-gray-600">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-md">
                    <div class="text-2xl mb-2">üí¨</div>
                    <div class="text-2xl font-bold text-blue-600">${stats.totalMessages}</div>
                    <div class="text-sm text-gray-600">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-md">
                    <div class="text-2xl mb-2">üé§</div>
                    <div class="text-2xl font-bold text-green-600">${stats.totalSpeaks}</div>
                    <div class="text-sm text-gray-600">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏π‡∏î</div>
                </div>
                <div class="bg-white rounded-xl p-4 shadow-md">
                    <div class="text-2xl mb-2">üìù</div>
                    <div class="text-2xl font-bold text-orange-600">${stats.vocabulary.size}</div>
                    <div class="text-sm text-gray-600">‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</div>
                </div>
            `;
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå
        function renderScenarios() {
            const grid = document.getElementById('scenarioGrid');
            grid.innerHTML = scenarios.map(s => `
                <button onclick="startScenario(${s.id})" class="bg-white rounded-2xl p-6 shadow-lg hover:shadow-xl transition-all hover:scale-105 text-left group">
                    <div class="text-5xl mb-4 group-hover:scale-110 transition-transform">${s.icon}</div>
                    <h3 class="text-lg font-bold text-gray-800 group-hover:text-purple-600 transition">${s.title}</h3>
                </button>
            `).join('');
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå
        function startScenario(id) {
            currentScenario = scenarios.find(s => s.id === id);
            messages = [{ role: 'assistant', content: currentScenario.greeting }];
            
            stats.sessionScore = 0;
            stats.sessionMessages = 0;
            stats.sessionSpeaks = 0;
            
            document.getElementById('scenarioSelection').classList.add('hidden');
            document.getElementById('conversationView').classList.remove('hidden');
            document.getElementById('scenarioIcon').textContent = currentScenario.icon;
            document.getElementById('scenarioTitle').textContent = currentScenario.title;
            
            updateScoreDisplay();
            renderMessages();
            speakText(currentScenario.greeting);
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô
            saveSession();
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô
        function saveSession() {
            const sessions = JSON.parse(localStorage.getItem('englishPracticeSessions') || '[]');
            sessions.unshift({
                scenario: currentScenario.title,
                date: new Date().toISOString(),
                messages: []
            });
            if (sessions.length > 20) sessions.pop();
            localStorage.setItem('englishPracticeSessions', JSON.stringify(sessions));
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô
        function updateSession(message) {
            const sessions = JSON.parse(localStorage.getItem('englishPracticeSessions') || '[]');
            if (sessions[0]) {
                sessions[0].messages.push(message);
                localStorage.setItem('englishPracticeSessions', JSON.stringify(sessions));
            }
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        function renderMessages() {
            const list = document.getElementById('messagesList');
            list.innerHTML = messages.map(msg => {
                if (msg.role === 'system') {
                    return `
                        <div class="flex justify-center my-4">
                            <div class="bg-gradient-to-r from-yellow-100 to-orange-100 border-2 border-yellow-400 rounded-xl px-6 py-4 max-w-2xl shadow-md">
                                <div class="flex items-start gap-3">
                                    <span class="text-2xl">üéØ</span>
                                    <div class="flex-1">
                                        <h4 class="font-bold text-orange-800 mb-2">‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á</h4>
                                        <div class="text-gray-700 whitespace-pre-line">${msg.content}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                return `
                    <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-[80%] rounded-2xl px-5 py-3 ${
                            msg.role === 'user' 
                                ? 'bg-purple-600 text-white' 
                                : 'bg-white text-gray-800 shadow-md'
                        }">
                            <p class="text-base leading-relaxed">${msg.content}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            list.scrollTop = list.scrollHeight;
        }

        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        async function sendMessage(spokenText = null) {
            const input = document.getElementById('messageInput');
            const text = spokenText || input.value.trim();
            
            if (!text || !currentScenario) return;
            
            messages.push({ role: 'user', content: text });
            input.value = '';
            renderMessages();
            
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
            stats.totalMessages++;
            stats.sessionMessages++;
            addScore(5);
            
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå
            text.toLowerCase().split(/\s+/).forEach(word => {
                const cleaned = word.replace(/[^a-z]/g, '');
                if (cleaned.length > 2) stats.vocabulary.add(cleaned);
            });
            
            updateSession({ role: 'user', content: text });
            
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î ‡πÉ‡∏´‡πâ AI ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á
            if (spokenText) {
                stats.totalSpeaks++;
                stats.sessionSpeaks++;
                addScore(10);
                updateScoreDisplay();
                await analyzePronunciation(spokenText);
            }
            
            showThinking();
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 150,
                        system: currentScenario.systemPrompt,
                        messages: messages.filter(m => m.role !== 'system').map(msg => ({
                            role: msg.role === 'assistant' ? 'assistant' : 'user',
                            content: msg.content
                        }))
                    })
                });

                const data = await response.json();
                const aiResponse = data.content[0].text;
                
                hideThinking();
                messages.push({ role: 'assistant', content: aiResponse });
                renderMessages();
                updateSession({ role: 'assistant', content: aiResponse });
                speakText(aiResponse);

            } catch (error) {
                console.error('Error:', error);
                hideThinking();
                const errorMsg = "Sorry, I didn't catch that. Could you say it again?";
                messages.push({ role: 'assistant', content: errorMsg });
                renderMessages();
                speakText(errorMsg);
            }
            
            saveData();
            updateScoreDisplay();
        }

        // ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        async function analyzePronunciation(spokenText) {
            showThinking();
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 200,
                        messages: [{
                            role: 'user',
                            content: `Analyze this English speech from a Thai learner: "${spokenText}"

Provide brief feedback in Thai (3-4 lines max) covering:
1. Overall pronunciation quality (Good/Fair/Needs practice)
2. Specific sounds that might need work (if any, like th, r, v, l)
3. One quick tip for improvement

Keep it encouraging and concise!`
                        }]
                    })
                });

                const data = await response.json();
                const feedback = data.content[0].text;
                
                hideThinking();
                messages.push({ role: 'system', content: feedback });
                renderMessages();
                updateSession({ role: 'system', content: feedback });
                
                // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á
                const soundMatches = feedback.match(/‡πÄ‡∏™‡∏µ‡∏¢‡∏á\s+"?([a-z]+)"?/gi);
                if (soundMatches) {
                    soundMatches.forEach(match => {
                        const sound = match.replace(/‡πÄ‡∏™‡∏µ‡∏¢‡∏á\s+"?/i, '').replace(/"?$/, '');
                        stats.pronunciationIssues[sound] = (stats.pronunciationIssues[sound] || 0) + 1;
                    });
                }
                
                addScore(20);
                saveData();

            } catch (error) {
                console.error('Pronunciation analysis error:', error);
                hideThinking();
            }
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
        function showStats() {
            const modal = document.getElementById('statsModal');
            const content = document.getElementById('statsContent');
            
            const topIssues = Object.entries(stats.pronunciationIssues)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            const recentWords = Array.from(stats.vocabulary).slice(-10).reverse();
            
            content.innerHTML = `
                <div class="space-y-6">
                    <!-- ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤ -->
                    <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl p-6">
                        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                            <span>üìà</span> ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πâ‡∏≤‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°
                        </h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="text-center">
                                <div class="text-3xl font-bold text-purple-600">${stats.totalScore}</div>
                                <div class="text-sm text-gray-600">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold text-blue-600">${stats.totalMessages}</div>
                                <div class="text-sm text-gray-600">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold text-green-600">${stats.totalSpeaks}</div>
                                <div class="text-sm text-gray-600">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏π‡∏î</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold text-orange-600">${stats.vocabulary.size}</div>
                                <div class="text-sm text-gray-600">‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</div>
                            </div>
                        </div>
                    </div>

                    <!-- ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ù‡∏∂‡∏Å -->
                    ${topIssues.length > 0 ? `
                    <div class="bg-yellow-50 rounded-xl p-6">
                        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                            <span>üéØ</span> ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ù‡∏∂‡∏Å‡∏ö‡πà‡∏≠‡∏¢‡πÜ
                        </h3>
                        <div class="space-y-2">
                            ${topIssues.map(([sound, count]) => `
                                <div class="flex items-center justify-between bg-white rounded-lg px-4 py-3">
                                    <span class="font-medium">‡πÄ‡∏™‡∏µ‡∏¢‡∏á "${sound}"</span>
                                    <span class="bg-yellow-200 px-3 py-1 rounded-full text-sm font-bold">${count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î -->
                    ${recentWords.length > 0 ? `
                    <div class="bg-green-50 rounded-xl p-6">
                        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                            <span>üìù</span> ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                        </h3>
                        <div class="flex flex-wrap gap-2">
                            ${recentWords.map(word => `
                                <span class="bg-white px-3 py-2 rounded-lg text-sm font-medium border border-green-200">${word}</span>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <!-- ‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -->
                    <div class="bg-blue-50 rounded-xl p-6">
                        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                            <span>üí´</span> ‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                        </h3>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="text-center bg-white rounded-lg p-3">
                                <div class="text-2xl font-bold text-purple-600">${stats.sessionScore}</div>
                                <div class="text-xs text-gray-600">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                            </div>
                            <div class="text-center bg-white rounded-lg p-3">
                                <div class="text-2xl font-bold text-blue-600">${stats.sessionMessages}</div>
                                <div class="text-xs text-gray-600">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</div>
                            </div>
                            <div class="text-center bg-white rounded-lg p-3">
                                <div class="text-2xl font-bold text-green-600">${stats.sessionSpeaks}</div>
                                <div class="text-xs text-gray-600">‡∏û‡∏π‡∏î</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeStats() {
            document.getElementById('statsModal').classList.add('hidden');
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        function showHistory() {
            const modal = document.getElementById('historyModal');
            const content = document.getElementById('historyContent');
            const sessions = JSON.parse(localStorage.getItem('englishPracticeSessions') || '[]');
            
            if (sessions.length === 0) {
                content.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-6xl mb-4">üìö</div>
                        <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</p>
                        <p class="text-sm mt-2">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>
                    </div>
                `;
            } else {
                content.innerHTML = sessions.map((session, idx) => {
                    const date = new Date(session.date);
                    const messageCount = session.messages.length;
                    return `
                        <div class="bg-white rounded-xl p-6 shadow-md mb-4 hover:shadow-lg transition">
                            <div class="flex items-start justify-between mb-3">
                                <div>
                                    <h3 class="font-bold text-lg">${session.scenario}</h3>
                                    <p class="text-sm text-gray-500">${date.toLocaleDateString('th-TH', { 
                                        year: 'numeric', 
                                        month: 'long', 
                                        day: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    })}</p>
                                </div>
                                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                                    ${messageCount} ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                                </span>
                            </div>
                            <div class="space-y-2 max-h-40 overflow-y-auto">
                                ${session.messages.slice(0, 5).map(msg => `
                                    <div class="text-sm ${msg.role === 'system' ? 'bg-yellow-50 p-2 rounded' : ''}">
                                        <span class="font-medium ${
                                            msg.role === 'user' ? 'text-purple-600' : 
                                            msg.role === 'assistant' ? 'text-blue-600' : 
                                            'text-orange-600'
                                        }">
                                            ${msg.role === 'user' ? 'üë§ ‡∏Ñ‡∏∏‡∏ì' : 
                                              msg.role === 'assistant' ? 'ü§ñ AI' : 'üéØ ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô'}:
                                        </span>
                                        ${msg.content.substring(0, 100)}${msg.content.length > 100 ? '...' : ''}
                                    </div>
                                `).join('')}
                                ${messageCount > 5 ? `<p class="text-xs text-gray-500 text-center mt-2">‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${messageCount - 5} ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</p>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            modal.classList.remove('hidden');
        }

        function closeHistory() {
            document.getElementById('historyModal').classList.add('hidden');
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ thinking
        function showThinking() {
            const list = document.getElementById('messagesList');
            const thinkingDiv = document.createElement('div');
            thinkingDiv.id = 'thinking';
            thinkingDiv.className = 'flex justify-start';
            thinkingDiv.innerHTML = `
                <div class="bg-white rounded-2xl px-5 py-3 shadow-md">
                    <div class="flex gap-2">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce-dot"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce-dot" style="animation-delay: 0.1s"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce-dot" style="animation-delay: 0.2s"></div>
                    </div>
                </div>
            `;
            list.appendChild(thinkingDiv);
            list.scrollTop = list.scrollHeight;
        }

        function hideThinking() {
            const thinking = document.getElementById('thinking');
            if (thinking) thinking.remove();
        }

        // ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        function speakText(text) {
            window.speechSynthesis.cancel();
            
            let voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) {
                window.speechSynthesis.onvoiceschanged = () => {
                    voices = window.speechSynthesis.getVoices();
                    speakWithVoice(text, voices);
                };
            } else {
                speakWithVoice(text, voices);
            }
        }

        function speakWithVoice(text, voices) {
            const utterance = new SpeechSynthesisUtterance(text);
            
            const preferredVoices = [
                'Google US English',
                'Google UK English Female',
                'Microsoft Zira',
                'Microsoft David',
                'Samantha',
                'Alex',
                'Karen',
                'Daniel'
            ];
            
            let selectedVoice = null;
            
            for (let preferred of preferredVoices) {
                selectedVoice = voices.find(voice => 
                    voice.name.includes(preferred) && voice.lang.startsWith('en')
                );
                if (selectedVoice) break;
            }
            
            if (!selectedVoice) {
                selectedVoice = voices.find(voice => 
                    voice.lang.startsWith('en') && 
                    (voice.name.includes('Natural') || voice.name.includes('Premium'))
                );
            }
            
            if (!selectedVoice) {
                selectedVoice = voices.find(voice => voice.lang.startsWith('en'));
            }
            
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            
            utterance.lang = 'en-US';
            utterance.rate = 0.95;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            utterance.onstart = () => {
                isAISpeaking = true;
                document.getElementById('aiSpeakingIndicator').classList.remove('hidden');
                updateButtons();
            };
            
            utterance.onend = () => {
                isAISpeaking = false;
                document.getElementById('aiSpeakingIndicator').classList.add('hidden');
                updateButtons();
            };
            
            window.speechSynthesis.speak(utterance);
        }

        // Speech Recognition
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;

                recognition.onstart = () => {
                    console.log('Speech recognition started');
                    isListening = true;
                    updateButtons();
                };

                recognition.onresult = (event) => {
                    console.log('Speech recognition result:', event);
                    const text = event.results[0][0].transcript;
                    console.log('Recognized text:', text);
                    document.getElementById('messageInput').value = text;
                    isListening = false;
                    updateButtons();
                    sendMessage(text);
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    isListening = false;
                    updateButtons();
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                    let errorMsg = '';
                    switch(event.error) {
                        case 'no-speech':
                            errorMsg = '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
                            break;
                        case 'audio-capture':
                            errorMsg = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå';
                            break;
                        case 'not-allowed':
                            errorMsg = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô';
                            break;
                        case 'network':
                            errorMsg = '‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢';
                            break;
                        default:
                            errorMsg = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + event.error;
                    }
                    
                    alert(errorMsg);
                };

                recognition.onend = () => {
                    console.log('Speech recognition ended');
                    isListening = false;
                    updateButtons();
                };
            } else {
                console.error('Speech recognition not supported');
                alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ Chrome ‡∏´‡∏£‡∏∑‡∏≠ Edge');
            }
        }

        async function startListening() {
            if (!recognition) {
                alert('‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                return;
            }

            if (isListening) {
                console.log('Already listening');
                return;
            }

            if (isAISpeaking) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÉ‡∏´‡πâ AI ‡∏û‡∏π‡∏î‡∏à‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
                return;
            }

            try {
                // ‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop()); // ‡∏õ‡∏¥‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÄ‡∏£‡∏≤‡πÅ‡∏Ñ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ permission
                
                console.log('Starting recognition...');
                isListening = true;
                updateButtons();
                recognition.start();
            } catch (err) {
                console.error('Microphone permission error:', err);
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå');
                isListening = false;
                updateButtons();
            }
        }

        function updateButtons() {
            const micBtn = document.getElementById('micBtn');
            const sendBtn = document.getElementById('sendBtn');
            const input = document.getElementById('messageInput');
            const status = document.getElementById('statusText');
            
            if (isListening) {
                micBtn.className = 'px-6 py-3 bg-red-500 text-white rounded-xl animate-pulse';
                micBtn.textContent = 'üé§';
                status.textContent = 'üé§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ü‡∏±‡∏á... ‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢';
            } else {
                micBtn.className = 'px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-xl hover:from-purple-700 hover:to-blue-700 transition';
                micBtn.textContent = 'üé§';
                status.textContent = '‡∏Å‡∏î‡πÑ‡∏°‡∏Ñ‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°';
            }
            
            const disabled = isAISpeaking || isListening;
            input.disabled = disabled;
            sendBtn.disabled = disabled;
            micBtn.disabled = isAISpeaking;
            
            if (disabled) {
                sendBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                sendBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function resetConversation() {
            messages = [];
            currentScenario = null;
            window.speechSynthesis.cancel();
            
            document.getElementById('scenarioSelection').classList.remove('hidden');
            document.getElementById('conversationView').classList.add('hidden');
            document.getElementById('messageInput').value = '';
            
            renderStatsOverview();
        }

        // Event listeners
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        loadData();
        renderScenarios();
        renderStatsOverview();
        initSpeechRecognition();

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed'));
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });

        function showInstallButton() {
            const installDiv = document.createElement('div');
            installDiv.id = 'installPrompt';
            installDiv.className = 'fixed bottom-4 right-4 bg-purple-600 text-white px-6 py-3 rounded-full shadow-lg z-50 flex items-center gap-3 cursor-pointer hover:bg-purple-700 transition';
            installDiv.innerHTML = `
                <span>üì±</span>
                <span class="font-medium">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ</span>
                <button onclick="closeInstallPrompt()" class="ml-2 text-white hover:text-gray-200">&times;</button>
            `;
            installDiv.onclick = (e) => {
                if (e.target.tagName !== 'BUTTON') installApp();
            };
            document.body.appendChild(installDiv);
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                    closeInstallPrompt();
                });
            }
        }

        function closeInstallPrompt() {
            const prompt = document.getElementById('installPrompt');
            if (prompt) prompt.remove();
        }
    </script>
</body>
</html>
